datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env ("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Atualizado com os status comuns de integração
enum PedidoStatus {
  RECEIVED
  CONFIRMED
  DISPATCHED
  READY
  CANCELLED
  PENDING
  SHIPPED
  DELIVERED
  READY_TO_PICKUP
  ORDER_NEW        // Adicionado para UaiRango
  PLACED           // Adicionado para UaiRango
}

model Empresa {
  id             String    @id @default(uuid())
  nome           String
  cnpj           String    @unique
  tenant_id      String?
  tokenUai       String?
  configUaiRango Json?
  createdAt      DateTime  @default(now())

  usuarios Usuario[]
  produtos Produto[]
  pedidos  Pedido[]
}

model Usuario {
  id        String   @id @default(uuid())
  nome      String
  email     String   @unique
  senha     String
  tenant_id String
  createdAt DateTime @default(now())

  empresa Empresa @relation(fields: [tenant_id], references: [id])
}

model Produto {
  id                  String   @id @default(uuid())
  externalId          String?  @unique
  externalCode        String?
  nome                String
  descricao           String?
  informacaoAdicional String?
  serving             String?
  peso                Float?
  
  tenant_id String
  empresa   Empresa @relation(fields: [tenant_id], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pedido {
  id           String       @id @default(uuid())
  uairango_id  String       @unique // O orderId do JSON
  displayId    String?      // O código curto 173DBEC9D
  status       String       @default("RECEIVED") // String é mais flexível para integrações
  
  // Financeiro (Decimal é melhor para dinheiro)
  valorTotal   Decimal      @default(0.0) @db.Decimal(10, 2)
  subTotal     Decimal      @default(0.0) @db.Decimal(10, 2)
  taxaEntrega  Decimal      @default(0.0) @db.Decimal(10, 2)
  
  // Dados do Cliente salvos no pedido (Snapshot)
  clienteNome  String?
  clienteDoc   String?
  clienteFone  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant_id String
  empresa   Empresa @relation(fields: [tenant_id], references: [id])
  
  // Relações Novas
  itens      PedidoItem[]
  pagamentos PedidoPagamento[]
  historico  PedidoHistorico[]

  json_bruto Json? // Recomendado salvar o JSON original para auditoria

  @@index([tenant_id])
}

model PedidoItem {
  id         String   @id @default(uuid())
  pedido_id  String
  pedido     Pedido   @relation(fields: [pedido_id], references: [id])
  
  externalId String?
  nome       String
  quantidade Int
  precoUnit  Decimal  @db.Decimal(10, 2)
  precoTotal Decimal  @db.Decimal(10, 2) // Incluindo opções
  obs        String?  @db.Text

  options    PedidoItemOption[]
}

model PedidoItemOption {
  id            String     @id @default(uuid())
  pedido_item_id String
  pedidoItem    PedidoItem @relation(fields: [pedido_item_id], references: [id])
  
  nome       String
  quantidade Int
  precoUnit  Decimal @db.Decimal(10, 2)
  precoTotal Decimal @db.Decimal(10, 2)
}

model PedidoPagamento {
  id        String  @id @default(uuid())
  pedido_id String
  pedido    Pedido  @relation(fields: [pedido_id], references: [id])
  
  metodo    String  // CASH, CREDIT_CARD
  tipo      String  // ONLINE, OFFLINE
  bandeira  String? // Visa, Master
  valor     Decimal @db.Decimal(10, 2)
  prepaid   Boolean @default(false)
}

model PedidoHistorico {
  id        String   @id @default(uuid())
  pedido_id String
  status    String   // Alterado para String para bater com Pedido
  createdAt DateTime @default(now())

  pedido Pedido @relation(fields: [pedido_id], references: [id])

  @@index([pedido_id])
}